name: Deploy to Staging

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  migrate-and-deploy:
    name: Migrate DB and Deploy (staging)
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dbmate
        run: |
          sudo curl -fsSL -o /usr/local/bin/dbmate https://github.com/amacneil/dbmate/releases/latest/download/dbmate-linux-amd64
          sudo chmod +x /usr/local/bin/dbmate
          dbmate --version

      - name: Run migrations on STAGING
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: dbmate up

      # Opcional: build do backend (se aplicável)
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps (optional)
        run: |
          if [ -f package.json ]; then pnpm install --frozen-lockfile || pnpm install; fi

      - name: Build (optional)
        run: |
          if [ -f package.json ]; then pnpm build || true; fi

      # Placeholder de deploy — trocaremos pelo alvo real depois
      - name: Deploy step (placeholder)
        run: |
          echo "Deploy para staging ainda não configurado."
          echo "Migrations aplicadas em staging usando secrets.DATABASE_URL."